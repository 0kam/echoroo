# ============================================
# Echoroo Development Image
# Uses pre-built base image with ML dependencies
# Fast rebuild - only copies source code
# ============================================
# Requires: docker build -f Dockerfile.base -t echoroo-base:latest .
# Build:    docker build -f Dockerfile.dev -t echoroo-dev:latest .
# ============================================
FROM echoroo-base:latest

WORKDIR /code

# Copy source code and README (for package metadata)
COPY README.md ./
COPY src/ ./src/

# Upgrade TensorFlow for GPU compatibility with PyTorch's CUDA libraries
# TensorFlow 2.20+ works with cuDNN 9.x which PyTorch 2.9+ requires
# nvidia-cuda-nvcc-cu12 provides libdevice.10.bc needed for XLA JIT compilation
# TensorFlow 2.20.0 is required for Perch V2 (XLA compatibility)
RUN pip install --no-cache-dir --upgrade tensorflow==2.20.0 nvidia-cuda-nvcc-cu12

# Install the project itself (fast - dependencies already installed)
RUN pip install -e . --no-deps

VOLUME ["/data"]

ENV ECHOROO_AUDIO_DIR=/audio \
    ECHOROO_HOST="0.0.0.0" \
    ECHOROO_DOMAIN="localhost"

# Default command for development
CMD ["python", "-m", "echoroo"]
