# 機能仕様書: システム管理

**フィーチャーブランチ**: `001-administration`
**作成日**: 2026-01-15
**ステータス**: ドラフト
**入力**: システム管理（ユーザー、プロジェクト、認証、システム設定）

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - ユーザー登録とログイン (優先度: P1)

新しいユーザーは、アカウントを作成してEchorooにログインし、システムの機能にアクセスしたい。

**優先度の理由**: 認証は全ての機能の前提条件。これがなければシステムを使用できない。

**独立テスト**: アカウント作成、ログイン、ログアウトの一連のフローをテスト可能。

**受け入れシナリオ**:

1. **Given** 未登録の状態で、**When** メールアドレスとパスワードで登録する、**Then** アカウントが作成されてログイン状態になる
2. **Given** アカウントが存在する状態で、**When** 正しい認証情報でログインする、**Then** ダッシュボードにリダイレクトされる
3. **Given** ログイン状態で、**When** ログアウトする、**Then** セッションが終了してログイン画面に戻る
4. **Given** パスワードを忘れた状態で、**When** パスワードリセットを要求する、**Then** リセットリンクがメールで送信される

---

### ユーザーストーリー 2 - プロジェクト作成と管理 (優先度: P1)

研究者は、研究プロジェクトを作成し、関連するデータセットやチームメンバーを管理したい。

**優先度の理由**: プロジェクトはデータとチームを整理する基本単位。複数の研究を区別するために必須。

**独立テスト**: プロジェクトを作成し、設定を変更し、メンバーを追加、削除することでテスト可能。

**受け入れシナリオ**:

1. **Given** ログイン状態で、**When** 新規プロジェクトを作成する、**Then** プロジェクト名、説明、対象分類群を設定できる
2. **Given** プロジェクトが存在する状態で、**When** プロジェクト設定を編集する、**Then** 変更が保存されて反映される
3. **Given** プロジェクトオーナーとして、**When** メンバーを招待する、**Then** 招待されたユーザーがプロジェクトにアクセスできるようになる
4. **Given** プロジェクトオーナーとして、**When** メンバーを削除する、**Then** 削除されたユーザーがプロジェクトにアクセスできなくなる
5. **Given** プロジェクト一覧で、**When** 自分のプロジェクトを表示する、**Then** 所属する全プロジェクトが一覧表示される

---

### ユーザーストーリー 3 - プロジェクトメンバー権限管理 (優先度: P2)

プロジェクトオーナーは、チームメンバーに異なる権限レベル（管理者、メンバー、閲覧者）を割り当てたい。

**優先度の理由**: チームコラボレーションに重要だが、最初は全メンバー同等権限でも運用可能。

**独立テスト**: 異なる権限レベルでメンバーを追加し、各権限の制限を確認。

**受け入れシナリオ**:

1. **Given** プロジェクトオーナーとして、**When** メンバーに「管理者」権限を付与する、**Then** そのメンバーはプロジェクト設定を変更できる
2. **Given** プロジェクトオーナーとして、**When** メンバーに「メンバー」権限を付与する、**Then** データの追加・編集は可能だが設定変更は不可
3. **Given** プロジェクトオーナーとして、**When** メンバーに「閲覧者」権限を付与する、**Then** データの閲覧のみ可能
4. **Given** メンバー権限を変更したい場合、**When** 権限レベルを更新する、**Then** 即座に新しい権限が適用される

---

### ユーザーストーリー 4 - ユーザープロフィール管理 (優先度: P2)

ユーザーは、自分のプロフィール情報を更新し、アカウント設定を管理したい。

**優先度の理由**: ユーザー体験の向上に重要だが、基本機能より後で実装可能。

**独立テスト**: プロフィールページでの情報更新と設定変更をテスト。

**受け入れシナリオ**:

1. **Given** ログイン状態で、**When** プロフィールページを開く、**Then** 現在の情報（名前、メール、所属など）が表示される
2. **Given** プロフィールページで、**When** 表示名を変更する、**Then** 変更が保存されてシステム全体に反映される
3. **Given** セキュリティ設定で、**When** パスワードを変更する、**Then** 新しいパスワードでログインできるようになる
4. **Given** 通知設定で、**When** メール通知のオン/オフを切り替える、**Then** 設定に応じてメールが送信される/されない

---

### ユーザーストーリー 5 - システム管理者機能 (優先度: P2)

システム管理者は、全ユーザーとプロジェクトを管理し、システム設定を構成したい。

**優先度の理由**: マルチテナント運用に必要だが、単一ユーザー/小規模チームでは後回し可能。

**独立テスト**: 管理者パネルで各管理機能が動作することを確認。

**受け入れシナリオ**:

1. **Given** システム管理者としてログイン、**When** 管理パネルを開く、**Then** 全ユーザー一覧が表示される
2. **Given** 管理パネルで、**When** ユーザーを検索する、**Then** 条件に一致するユーザーが表示される
3. **Given** 管理パネルで、**When** ユーザーを無効化する、**Then** そのユーザーはログインできなくなる
4. **Given** システム設定で、**When** 新規登録を無効にする、**Then** 新しいアカウント作成ができなくなる

---

### ユーザーストーリー 6 - 初回セットアップ (優先度: P1)

システムを初めてデプロイした管理者は、初期設定を行い最初の管理者アカウントを作成したい。

**優先度の理由**: システム導入の最初のステップ。これがなければ誰もシステムを使い始められない。

**独立テスト**: 新規インストール後に初回セットアップウィザードを完了できることを確認。

**受け入れシナリオ**:

1. **Given** システムが初めて起動した状態で、**When** セットアップページにアクセスする、**Then** 初期設定ウィザードが表示される
2. **Given** セットアップウィザードで、**When** 管理者アカウント情報を入力する、**Then** 最初の管理者ユーザーが作成される
3. **Given** セットアップ完了後、**When** 再度セットアップページにアクセスする、**Then** アクセスが拒否される（セキュリティ）
4. **Given** 管理者アカウント作成後、**When** ログインする、**Then** 管理者権限でシステムにアクセスできる

---

### ユーザーストーリー 7 - APIトークン管理 (優先度: P3)

開発者は、外部ツールやスクリプトからEchorooにアクセスするためのAPIトークンを作成・管理したい。

**優先度の理由**: API連携に有用だが、Webインターフェースでの基本機能が優先。

**独立テスト**: トークンを生成し、APIアクセスに使用できることを確認。

**受け入れシナリオ**:

1. **Given** プロフィール設定で、**When** 新規APIトークンを生成する、**Then** トークン文字列が表示される（一度のみ）
2. **Given** APIトークンがある状態で、**When** トークン一覧を表示する、**Then** 作成日時と最終使用日時が確認できる
3. **Given** APIトークンを使用して、**When** APIリクエストを送信する、**Then** 認証済みとして処理される
4. **Given** 不要なトークンがある状態で、**When** トークンを取り消す、**Then** そのトークンでのアクセスが無効になる

---

### ユーザーストーリー 8 - レコーダー管理 (優先度: P2)

システム管理者は、システム全体で使用される録音機器（レコーダー）のマスタデータを管理したい。

**優先度の理由**: データセット作成時にレコーダーを選択する必要があるため、基本的なマスタデータ。

**独立テスト**: レコーダーの作成、編集、削除、一覧表示をテスト。

**初期データ（シードデータ）**:

| ID | 名前 | 製造メーカー | バージョン |
|----|------|-------------|-----------|
| am120 | AudioMoth | Open Acoustic Devices | 1.2.0 |
| smmicro2 | Song Meter Micro2 | Wildlife Acoustics | - |
| smmini2li | Song Meter Mini2 Li-ion | Wildlife Acoustics | - |
| smmini2aa | Song Meter Mini2 AA | Wildlife Acoustics | - |
| sm4 | Song Meter SM4 | Wildlife Acoustics | - |
| sm5 | Song Meter SM5 | Wildlife Acoustics | - |

**受け入れシナリオ**:

1. **Given** 管理者としてログイン、**When** レコーダー管理画面を開く、**Then** 全レコーダー一覧が表示される
2. **Given** 管理画面で、**When** 新規レコーダーを作成する、**Then** レコーダーID、名前、製造メーカー、バージョンを設定できる
3. **Given** レコーダー一覧で、**When** レコーダーを検索する、**Then** IDまたは名前で絞り込まれる
4. **Given** 既存レコーダーで、**When** 情報を編集する、**Then** 変更が保存される
5. **Given** 使用されていないレコーダーで、**When** 削除する、**Then** レコーダーが削除される
6. **Given** データセットで使用中のレコーダーで、**When** 削除しようとする、**Then** エラーが表示され削除がブロックされる

---

### ユーザーストーリー 9 - ライセンス管理 (優先度: P2)

システム管理者は、データセットに適用されるライセンスのマスタデータを管理したい。

**優先度の理由**: データセット公開時にライセンスを選択する必要があるため、基本的なマスタデータ。

**独立テスト**: ライセンスの作成、編集、削除、一覧表示をテスト。

**初期データ（シードデータ）** - Xeno-canto準拠:

| ID | 名前 | 説明 | リンクURL |
|----|------|------|----------|
| BY-NC-ND | Attribution-NonCommercial-NoDerivs | 最も制限的。帰属表示必須、非商用、改変禁止。ダウンロード・再配布は可能だが、商用利用・改変は不可 | https://creativecommons.org/licenses/by-nc-nd/4.0/ |
| BY-NC-SA | Attribution-NonCommercial-ShareAlike | 帰属表示必須、非商用、継承。改変・派生作品の作成可能だが、同一ライセンスで公開し、商用利用は不可 | https://creativecommons.org/licenses/by-nc-sa/4.0/ |
| BY-SA | Attribution-ShareAlike | 帰属表示必須、継承。商用利用可能だが、派生作品も同一ライセンスで公開必須。購入者も自由に再配布可能 | https://creativecommons.org/licenses/by-sa/4.0/ |

**受け入れシナリオ**:

1. **Given** 管理者としてログイン、**When** ライセンス管理画面を開く、**Then** 全ライセンス一覧が表示される
2. **Given** 管理画面で、**When** 新規ライセンスを作成する、**Then** ライセンスID、名前、説明、リンクURLを設定できる
3. **Given** ライセンス一覧で、**When** ライセンスを検索する、**Then** IDまたは名前で絞り込まれる
4. **Given** 既存ライセンスで、**When** 情報を編集する、**Then** 変更が保存される
5. **Given** 使用されていないライセンスで、**When** 削除する、**Then** ライセンスが削除される
6. **Given** データセットで使用中のライセンスで、**When** 削除しようとする、**Then** エラーが表示され削除がブロックされる

---

### エッジケース

- 同じメールアドレスで複数回登録しようとした場合どうなるか？ → エラーメッセージを表示し、既存アカウントへのログインを提案
- プロジェクトオーナーが自分自身を削除しようとした場合どうなるか？ → ブロックし、まず別のオーナーを指定するよう要求
- 最後の管理者を無効化しようとした場合どうなるか？ → ブロックし、最低1人の管理者が必要であることを通知
- セッションが長時間アイドル状態の場合どうなるか？ → 自動ログアウトし、再ログインを要求
- パスワードリセットリンクが期限切れの場合どうなるか？ → エラーを表示し、新しいリセットリンクの要求を案内
- 同じレコーダーIDで登録しようとした場合どうなるか？ → エラーメッセージを表示し、既存レコーダーの編集を提案
- 同じライセンスIDで登録しようとした場合どうなるか？ → エラーメッセージを表示し、既存ライセンスの編集を提案

## 要件 *(必須)*

### 機能要件

#### ユーザー認証
- **FR-001**: システムは、メールアドレスとパスワードによるユーザー登録をサポートしなければならない
- **FR-001a**: システムは、登録時にメール確認リンクを送信し、確認完了までログインをブロックしなければならない
- **FR-002**: システムは、ユーザーログイン/ログアウト機能を提供しなければならない
- **FR-003**: システムは、パスワードリセット機能を提供しなければならない
- **FR-004**: システムは、セッションタイムアウトを設定可能にしなければならない（デフォルト: 2時間）
- **FR-005**: システムは、パスワードを安全にハッシュ化して保存しなければならない
- **FR-005a**: パスワードは最低8文字以上、英字と数字の混合を必須とする
- **FR-005b**: システムは、ログイン失敗を5回連続した場合、15分間アカウントをロックしなければならない
- **FR-005c**: システムは、ログイン失敗が3回に達した時点でCAPTCHAを表示しなければならない

#### ユーザー管理
- **FR-006**: システムは、ユーザープロフィール情報（名前、所属、メール）を保存できなければならない
- **FR-007**: システムは、ユーザーが自分のプロフィールを編集できなければならない
- **FR-008**: システムは、ユーザーがパスワードを変更できなければならない
- **FR-009**: システムは、ユーザーの通知設定を管理できなければならない

#### プロジェクト管理
- **FR-010**: システムは、プロジェクトの作成・編集・削除をサポートしなければならない
- **FR-011**: システムは、プロジェクトに名前、説明、対象分類群を設定できなければならない
- **FR-012**: システムは、プロジェクトにメンバーを追加・削除できなければならない
- **FR-013**: システムは、プロジェクトの可視性（プライベート/公開）を設定できなければならない

#### 権限管理
- **FR-014**: システムは、ユーザーロール（管理者、メンバー、閲覧者）を定義しなければならない
- **FR-015**: システムは、プロジェクトレベルでの権限割り当てをサポートしなければならない
- **FR-016**: システムは、権限に基づいてアクセス制御を実施しなければならない
- **FR-017**: システムは、スーパーユーザー（システム管理者）権限をサポートしなければならない

#### システム管理
- **FR-018**: システムは、管理者向けのユーザー一覧・検索機能を提供しなければならない
- **FR-019**: システムは、管理者がユーザーを有効化/無効化できなければならない
- **FR-020**: システムは、新規登録の有効/無効を設定できなければならない
- **FR-020a**: システムは、登録モード（オープン登録/招待制）をシステム設定で切り替えられなければならない
- **FR-020b**: 招待制モードでは、既存ユーザーまたは管理者からの招待リンクでのみ登録可能とする
- **FR-021**: システムは、システム全体の設定を管理できなければならない

#### 初回セットアップ
- **FR-022**: システムは、初回起動時にセットアップウィザードを表示しなければならない
- **FR-023**: システムは、最初の管理者アカウント作成をサポートしなければならない
- **FR-024**: システムは、セットアップ完了後にセットアップページへのアクセスをブロックしなければならない

#### APIトークン
- **FR-025**: システムは、ユーザーがAPIトークンを生成できなければならない
- **FR-026**: システムは、APIトークンによる認証をサポートしなければならない
- **FR-027**: システムは、トークンの取り消し機能を提供しなければならない
- **FR-028**: システムは、トークンの使用履歴を記録しなければならない

#### レコーダー管理
- **FR-029**: システムは、レコーダー（録音機器）のマスタデータを管理できなければならない
- **FR-030**: システムは、レコーダーにID、名前、製造メーカー、バージョンを設定できなければならない
- **FR-031**: システムは、レコーダーの一覧表示と検索機能を提供しなければならない
- **FR-032**: システムは、使用中のレコーダーの削除を防止しなければならない
- **FR-033**: システムは、デフォルトのレコーダー（AudioMoth、Song Meterシリーズなど）を初期データとして提供しなければならない

#### ライセンス管理
- **FR-034**: システムは、ライセンスのマスタデータを管理できなければならない
- **FR-035**: システムは、ライセンスにID、名前、説明、リンクURLを設定できなければならない
- **FR-036**: システムは、ライセンスの一覧表示と検索機能を提供しなければならない
- **FR-037**: システムは、使用中のライセンスの削除を防止しなければならない
- **FR-038**: システムは、Xeno-canto準拠のデフォルトライセンス（BY-NC-ND、BY-NC-SA、BY-SA）を初期データとして提供しなければならない

### 主要エンティティ

- **User（ユーザー）**: システムを使用する個人。メールアドレス、パスワードハッシュ、プロフィール情報、ロールを持つ
- **Project（プロジェクト）**: 研究プロジェクトの管理単位。名前、説明、対象分類群、可視性設定、オーナーを持つ
- **ProjectMember（プロジェクトメンバー）**: プロジェクトとユーザーの関連。ロール（管理者/メンバー/閲覧者）を持つ
- **APIToken（APIトークン）**: 外部アクセス用の認証トークン。トークン文字列、作成日時、最終使用日時、有効状態を持つ
- **SystemSetting（システム設定）**: システム全体の設定値。キーと値のペアで保存
- **Recorder（レコーダー）**: 録音機器のマスタデータ。レコーダーID、名前、製造メーカー、バージョン、使用カウントを持つ
- **License（ライセンス）**: データセットに適用されるライセンス。ライセンスID、名前、説明、リンクURL、使用カウントを持つ

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザー登録が2分以内に完了できる
- **SC-002**: ログイン処理が1秒以内に完了する
- **SC-003**: 95%のユーザーが初回ログイン時に追加サポートなしでシステムを使用開始できる
- **SC-004**: プロジェクト作成が30秒以内に完了できる
- **SC-005**: 管理者が1000ユーザーの中から特定ユーザーを5秒以内に検索できる
- **SC-006**: パスワードリセットメールが要求から1分以内に送信される
- **SC-007**: 権限変更が即座（1秒以内）に反映される
- **SC-008**: システムが100人の同時ログインを処理できる
- **SC-009**: レコーダー・ライセンスの一覧が1秒以内に表示される

## 前提条件

- メール送信機能（SMTPサーバーまたはメールサービス）が設定されている
- ユーザーは有効なメールアドレスを持っている
- 初回セットアップは管理者が物理的にアクセスできる環境で行われる

## Clarifications

### Session 2026-01-15

- Q: パスワードポリシーはどの程度の強度にするか？ → A: 最低8文字 + 英数字混合必須（標準）
- Q: ユーザー登録フローはどうするか？ → A: オープン登録と招待制をシステム設定で切り替え可能にする
- Q: セッションタイムアウトのデフォルト値は？ → A: 2時間（標準）
- Q: ログイン試行の制限は？ → A: 5回失敗で15分ロック + 3回失敗後からCAPTCHA表示
- Q: メール確認は必要か？ → A: 必須（確認リンクをクリックするまでログイン不可）

### Session 2026-01-16

- Q: プロジェクトメンバーのロール体系は？ → A: 管理者/メンバー/閲覧者の3ロール（より細かい権限制御）
- スコープ変更: 監視サイト管理、タグ管理、MLモデル設定を本specから削除（別機能のスコープへ移動）
- レコーダー初期データ: AudioMoth, Song Meter Micro2/Mini2/SM4/SM5を追加
- ライセンス初期データ: Xeno-canto準拠のCC BY-NC-ND, BY-NC-SA, BY-SAを追加
