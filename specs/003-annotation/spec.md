# 機能仕様書: 音声イベントアノテーション

**フィーチャーブランチ**: `003-annotation`
**作成日**: 2026-01-15
**ステータス**: ドラフト
**入力**: 音声イベントアノテーション（アノテーションプロジェクト、タスク、タグ付け、レビューワークフロー）

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - アノテーションプロジェクトの作成 (優先度: P1)

研究者は、特定の種（例：特定の鳥類）を検出するためのアノテーションプロジェクトを作成したい。プロジェクトには対象タグ、アノテーション指示、使用するデータセットを設定する。

**優先度の理由**: アノテーションワークフローの基盤。プロジェクトなしではタスクの作成や管理ができない。

**独立テスト**: プロジェクトを作成し、設定を確認することで完全にテスト可能。

**受け入れシナリオ**:

1. **Given** ユーザーがログインしている状態で、**When** 新規アノテーションプロジェクトを作成する、**Then** プロジェクト名、説明、対象タグを設定できる
2. **Given** プロジェクトが存在する状態で、**When** データセットを関連付ける、**Then** そのデータセットのクリップがアノテーション対象になる
3. **Given** プロジェクトを作成する際に、**When** アノテーション指示を入力する、**Then** アノテーターに表示されるガイドラインとして保存される
4. **Given** プロジェクトが存在する状態で、**When** プロジェクト詳細を閲覧する、**Then** 進捗状況（完了タスク数/総タスク数）が表示される

---

### ユーザーストーリー 2 - アノテーションタスクの実行 (優先度: P1)

アノテーターは、割り当てられたタスクを実行し、音声クリップに対してタグを付けたり、音声イベントの境界を描画したりしたい。

**優先度の理由**: コアとなるアノテーション作業。これがなければアノテーションデータを生成できない。

**独立テスト**: タスクを開始し、アノテーションを追加して保存することでテスト可能。

**受け入れシナリオ**:

1. **Given** アノテーターにタスクが割り当てられている状態で、**When** タスクを開始する、**Then** クリップのスペクトログラムと再生コントロールが表示される
2. **Given** スペクトログラムが表示されている状態で、**When** 時間・周波数範囲を選択してバウンディングボックスを描画する、**Then** 音声イベントとして保存できる
3. **Given** 音声イベントを作成した状態で、**When** タグを選択する、**Then** そのイベントにタグが関連付けられる
4. **Given** アノテーション作業中に、**When** タスクを完了としてマークする、**Then** 次のタスクに進むか、完了画面が表示される

---

### ユーザーストーリー 3 - タグ管理 (優先度: P2)

研究者は、プロジェクトで使用するタグ（種名、音声タイプなど）を作成・管理したい。

**優先度の理由**: タグはアノテーションの分類に必須だが、デフォルトタグでも開始可能。

**独立テスト**: タグを作成、編集、削除し、アノテーションで使用できることを確認。

**受け入れシナリオ**:

1. **Given** タグ管理画面で、**When** 新規タグを作成する、**Then** タグ名とカテゴリ（種、音声タイプ、品質など）を設定できる
2. **Given** タグが存在する状態で、**When** 親タグを設定する、**Then** 階層構造が作成される
3. **Given** 種タグを作成する際に、**When** GBIF検索を使用する、**Then** 学名と一般名が自動入力される
4. **Given** タグ一覧を表示する際に、**When** 使用統計を確認する、**Then** 各タグの使用回数が表示される

---

### ユーザーストーリー 4 - クリップレベルアノテーション (優先度: P2)

アノテーターは、クリップ全体に対してタグを付けたい（詳細な境界指定なしで、存在/不在の判定のみ）。

**優先度の理由**: 詳細なバウンディングボックスより簡易で、大量データの初期スクリーニングに有用。

**独立テスト**: クリップを選択し、タグを付けて保存できることを確認。

**受け入れシナリオ**:

1. **Given** クリップ一覧が表示されている状態で、**When** クリップを選択してタグを追加する、**Then** クリップアノテーションとして保存される
2. **Given** 複数のクリップが選択されている状態で、**When** 一括でタグを適用する、**Then** 選択した全クリップにタグが追加される
3. **Given** クリップアノテーションが存在する状態で、**When** ノートを追加する、**Then** コメントがアノテーションに関連付けられる

---

### ユーザーストーリー 5 - アノテーションレビュー (優先度: P2)

プロジェクト管理者は、他のアノテーターが作成したアノテーションをレビューし、フィードバックを提供したい。

**優先度の理由**: 品質管理に重要だが、初期段階ではレビューなしでも運用可能。

**独立テスト**: 他者のアノテーションを閲覧し、承認/却下/コメントできることを確認。

**受け入れシナリオ**:

1. **Given** レビュー待ちのアノテーションがある状態で、**When** レビュー画面を開く、**Then** アノテーション詳細とスペクトログラムが表示される
2. **Given** アノテーションをレビュー中に、**When** 承認する、**Then** アノテーションステータスが「承認済み」になる
3. **Given** アノテーションをレビュー中に、**When** 却下してコメントを追加する、**Then** アノテーターに修正依頼が通知される
4. **Given** レビュー済みアノテーション一覧で、**When** フィルタを適用する、**Then** ステータス別（承認済み/却下/未レビュー）に絞り込める

---

### ユーザーストーリー 6 - アノテーションエクスポート (優先度: P3)

研究者は、完成したアノテーションデータを外部形式でエクスポートし、他のツールや論文で使用したい。

**優先度の理由**: データ活用に重要だが、システム内での利用が優先。

**独立テスト**: プロジェクトのアノテーションを各形式でエクスポートし、ファイルを検証。

**受け入れシナリオ**:

1. **Given** アノテーションプロジェクトが存在する状態で、**When** JSON形式でエクスポートする、**Then** 全アノテーションがJSONファイルとしてダウンロードされる
2. **Given** エクスポート時に、**When** CSV形式を選択する、**Then** 表形式のデータがダウンロードされる
3. **Given** エクスポート時に、**When** AOEF形式を選択する、**Then** Acoustic Observation Exchange Format仕様に準拠したファイルが生成される

---

### エッジケース

- 同じ時間範囲に複数のアノテーションが重複した場合どうなるか？ → 許可し、異なる種や音声タイプとして保存可能
- アノテーション中にセッションがタイムアウトした場合どうなるか？ → 未保存の作業を自動保存し、再開可能
- 対象外の音声が含まれるクリップの場合どうなるか？ → 「対象外」タグまたはスキップオプションを提供
- アノテーターが誤ってタスクを完了マークした場合どうなるか？ → 管理者がステータスを戻せる
- 大量のタスクを一度に作成した場合のパフォーマンスは？ → バックグラウンド処理で段階的に作成

## 要件 *(必須)*

### 機能要件

#### アノテーションプロジェクト管理
- **FR-001**: システムは、名前、説明、対象タグを持つアノテーションプロジェクトを作成できなければならない
- **FR-002**: システムは、プロジェクトにデータセットを関連付けられなければならない
- **FR-003**: システムは、プロジェクトのアノテーション指示（ガイドライン）を保存・表示できなければならない
- **FR-004**: システムは、プロジェクトの進捗状況（完了/未完了タスク数）を追跡できなければならない
- **FR-005**: システムは、プロジェクトの可視性設定（プライベート/公開）を管理できなければならない

#### タスク管理
- **FR-006**: システムは、クリップからアノテーションタスクを作成できなければならない
- **FR-007**: システムは、複数クリップから一括でタスクを生成できなければならない
- **FR-008**: システムは、タスクのステータス（未着手/進行中/完了/レビュー待ち）を追跡できなければならない
- **FR-009**: システムは、タスクをアノテーターに割り当てられなければならない
- **FR-010**: システムは、タスクの優先度とフィルタリングをサポートしなければならない

#### 音声イベントアノテーション
- **FR-011**: システムは、時間・周波数範囲を指定したバウンディングボックスアノテーションを作成できなければならない
- **FR-012**: システムは、音声イベントにタグを関連付けられなければならない
- **FR-013**: システムは、音声イベントにノート/コメントを追加できなければならない
- **FR-014**: システムは、アノテーションのソース（人間/モデル）を記録しなければならない
- **FR-015**: システムは、アノテーションの信頼度スコアを保存できなければならない

#### クリップアノテーション
- **FR-016**: システムは、クリップ全体へのタグ付け（存在/不在判定）をサポートしなければならない
- **FR-017**: システムは、複数クリップへの一括タグ付けをサポートしなければならない
- **FR-018**: システムは、クリップアノテーションにノートを追加できなければならない

#### タグ管理
- **FR-019**: システムは、カテゴリ別（種、音声タイプ、品質）のタグを作成できなければならない
- **FR-020**: システムは、タグの階層構造（親子関係）をサポートしなければならない
- **FR-021**: システムは、GBIF連携による種タグの自動補完をサポートしなければならない
- **FR-022**: システムは、タグの使用統計を提供しなければならない

#### レビュー機能
- **FR-023**: システムは、アノテーションのレビューワークフローをサポートしなければならない
- **FR-024**: システムは、レビューステータス（未レビュー/承認/却下）を管理できなければならない
- **FR-025**: システムは、レビューコメント/フィードバックを保存できなければならない

#### エクスポート
- **FR-026**: システムは、アノテーションをJSON形式でエクスポートできなければならない
- **FR-027**: システムは、アノテーションをCSV形式でエクスポートできなければならない
- **FR-028**: システムは、アノテーションをAOEF形式でエクスポートできなければならない

### 主要エンティティ

- **AnnotationProject（アノテーションプロジェクト）**: アノテーション作業を管理する単位。名前、説明、対象タグ、関連データセット、指示を持つ
- **AnnotationTask（アノテーションタスク）**: 個別のアノテーション作業単位。クリップへの参照、割り当てアノテーター、ステータスを持つ
- **SoundEventAnnotation（音声イベントアノテーション）**: 音声内の特定イベントを示す。時間範囲、周波数範囲、タグ、信頼度、ソース（人間/モデル）を持つ
- **ClipAnnotation（クリップアノテーション）**: クリップ全体への分類。タグと存在/不在の判定を持つ
- **Tag（タグ）**: 分類用のラベル。名前、カテゴリ、親タグ（階層用）を持つ
- **Note（ノート）**: アノテーションに付随するコメント。内容と作成者を持つ

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: アノテーターは1時間あたり100クリップ以上をアノテーションできる
- **SC-002**: バウンディングボックスの描画が500ms以内に応答する
- **SC-003**: タスク一覧の読み込みが2秒以内に完了する（1000タスクまで）
- **SC-004**: 95%のアノテーターが初回使用時にチュートリアルなしでタスクを完了できる
- **SC-005**: エクスポート処理が1分以内に完了する（10,000アノテーションまで）
- **SC-006**: アノテーション間の一貫性（Inter-annotator agreement）が80%以上達成可能
- **SC-007**: レビューワークフローにより品質問題の検出率が50%向上する

## 前提条件

- アノテーション対象のクリップはデータ管理機能で既にインポート済み
- アノテーターはスペクトログラムの基本的な読み方を理解している
- 種タグはGBIF（Global Biodiversity Information Facility）のデータベースと互換性がある
- アノテーションの重複（同じ時間範囲に複数のタグ）は許可される
