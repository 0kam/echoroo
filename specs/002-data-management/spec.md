# 機能仕様書: 音声データ管理

**フィーチャーブランチ**: `002-data-management`
**作成日**: 2026-01-15
**ステータス**: ドラフト
**入力**: 音声データ管理（録音、データセット、クリップ、音声処理）

## データ階層構造

Echorooは以下の厳密なデータ階層に従います：

```
Project（プロジェクト）
  └── Site（サイト）- Uber H3 hexで定義
        └── Dataset（データセット）
              └── Recording（録音）
                    └── Clip（クリップ）
```

- **サイトはプロジェクトに必ず属する**
- **データセットはサイトに必ず属する**（サイトのないデータセットは作成不可）
- サイトはUber H3の六角形セルで地理的に定義される（解像度5〜15）

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - サイトの作成と管理 (優先度: P1)

研究者は、フィールド調査を行う地理的位置（サイト）を定義して、録音データを空間的に整理したい。Uber H3の六角形セルを使用して、レコーダー設置場所を不確実性を含めた形で柔軟に指定できる。不確実性は希少種が含まれている場合など、録音地点を明らかにできない場合に必要。

**優先度の理由**: サイトはデータセット作成の前提条件。データ階層の基盤となるため、最初に作成する必要がある。

**独立テスト**: マップ上でH3 hexを選択してサイトを作成し、そのサイトにデータセットを関連付けられることを確認することでテスト可能。

**受け入れシナリオ**:

1. **Given** ユーザーがプロジェクトを管理している状態で、**When** 新しいサイトを作成する、**Then** マップ上でH3 hexを選択するUIが表示される
2. **Given** サイト作成UIが表示されている状態で、**When** ユーザーがH3解像度（5〜15）を選択する、**Then** マップ上のhex表示がその解像度に応じて変化する
3. **Given** ユーザーがマップ上でH3 hexを選択した状態で、**When** サイト名を入力して保存する、**Then** サイトが作成され、データセット作成時に選択可能になる
4. **Given** プロジェクトにサイトが存在する状態で、**When** ユーザーがサイト一覧を閲覧する、**Then** マップ上に全サイトのH3 hexが可視化される
5. **Given** サイトが存在する状態で、**When** ユーザーがサイト情報（名前、H3 hex）を編集する、**Then** 変更が保存され、関連するデータセットに反映される
6. **Given** データセットが関連付けられていないサイトで、**When** ユーザーが削除する、**Then** サイトが削除される
7. **Given** データセットが関連付けられているサイトで、**When** ユーザーが削除しようとする、**Then** 警告が表示され、関連データセットの移動または削除を求められる

---

### ユーザーストーリー 2 - 音声データセットのインポート (優先度: P1)

研究者は、フィールド調査で収集した音声録音のコレクションをEchorooにインポートして分析したい。ファイル名にメタデータ（日付、時刻、場所のパターンなど）が埋め込まれた音声ファイルのディレクトリを持っている。データセットには使用した録音機器、ライセンス、DOIなどのメタデータを関連付けることができる。

**優先度の理由**: これは基盤となるアクション。データをインポートしなければ、他の機能は動作しない。録音がシステムにない状態では、アノテーション、検索、分析ができない。

**独立テスト**: 音声ファイルのフォルダをアップロードし、抽出されたメタデータとともにシステムに表示されることを確認することで完全にテスト可能。

**受け入れシナリオ**:

1. **Given** ユーザーが音声ファイルのディレクトリを持っている状態で、**When** 新しいデータセットを作成する、**Then** 所属するサイトの選択が必須となる
2. **Given** データセット作成フォームで、**When** ユーザーがメタデータを入力する、**Then** 以下の項目を設定できる：
   - レコーダー（録音機器）- マスタデータから選択
   - ライセンス - マスタデータから選択
   - DOI（デジタルオブジェクト識別子）
   - ゲイン（dB）- 録音時の増幅設定
   - ノート - 内部用メモ
3. **Given** サイトを選択した状態で、**When** ディレクトリパスを指定する、**Then** システムはサポートされている全ての音声ファイルをスキャンしてインポートする
4. **Given** 音声ファイルのファイル名に日時パターンがある場合（例：`SITE01_20240315_143000.wav`）、**When** ユーザーが日時パターンをWebUI上で指定する、**Then** システムは各録音の日時メタデータを抽出して保存する
5. **Given** インポートが開始されたあとで、**When** 音声ファイルを読み込んだ際、**Then** システムは各録音のビット深度とサンプリングレートを抽出して保存する
6. **Given** インポートが進行中の状態で、**When** ユーザーがデータセットを閲覧する、**Then** インポートステータス（待機中、スキャン中、処理中、完了、失敗）が表示される
7. **Given** データセットのインポートが完了した状態で、**When** ユーザーがデータセットを閲覧する、**Then** インポートされた録音の概要（総数、合計時間、エラー）と設定したメタデータが表示される
8. **Given** 既存のデータセットが存在する状態で、**When** ユーザーがメタデータを編集する、**Then** レコーダー、ライセンス、DOI、ゲイン、ノートを更新できる
9. **Given** データセット作成前に、**When** ユーザーが候補ディレクトリの検出を要求する、**Then** サーバー上のインポート可能なディレクトリ一覧（ファイル数、形式情報を含む）が表示される
10. **Given** 既存のデータセットが存在する状態で、**When** ユーザーが再スキャンを要求する、**Then** システムはディレクトリ内の新規ファイルを検出してインポートする
11. **Given** データセットが存在する状態で、**When** ユーザーが詳細統計を閲覧する、**Then** カレンダー集計（日付・時間帯別）、録音分布のヒートマップ、タイムライン情報が表示される
12. **Given** データセットが存在する状態で、**When** ユーザーが削除を要求する、**Then** 警告が表示され、確認後にデータセットと全録音がカスケード削除される

---

### ユーザーストーリー 3 - 録音の閲覧と探索 (優先度: P1)

研究者は、インポートした録音を閲覧し、メタデータを確認し、音声を再生して、さらなる分析のための興味深い音声を見つけたい。超音波録音（コウモリ等）の場合は、time expansionによる減速再生で可聴域として確認できる必要がある。

**優先度の理由**: 全ての下流ワークフローを可能にするコア機能。アノテーションや分析の前に、ユーザーはデータを見つけてアクセスする必要がある。

**独立テスト**: サンプル録音をインポートし、ユーザーが一覧表示、フィルタリング、検索、再生できることを確認することでテスト可能。

**受け入れシナリオ**:

1. **Given** 録音を含むデータセットが存在する状態で、**When** ユーザーが録音一覧に移動する、**Then** 主要なメタデータ（ファイル名、長さ、日時、サイト、サンプリングレート）を含む録音のページネーションされた一覧が表示される
2. **Given** 録音一覧が表示されている状態で、**When** ユーザーが録音をクリックする、**Then** スペクトログラム可視化と再生コントロールを含む録音詳細ページが表示される
3. **Given** 録音に日時メタデータがある状態で、**When** ユーザーが日付範囲でフィルタリングする、**Then** その範囲内の録音のみが表示される
4. **Given** 録音詳細ページで、**When** ユーザーがスペクトログラムパラメータ（周波数範囲、カラーマップ）を調整する、**Then** 可視化がそれに応じて更新される
5. **Given** 超音波録音（サンプルレート > 48kHz）が存在する状態で、**When** ユーザーが再生する、**Then** システムは自動的に48kHzにリサンプリングしてブラウザで再生可能にする（スペクトログラムは元のサンプルレートで生成）
6. **Given** 録音詳細ページで、**When** ユーザーが再生速度を選択する（0.1x〜3x）、**Then** 音声が選択した速度で再生される（出力サンプルレート8kHz〜96kHz範囲内に制限）（出力サンプリングレートが48kHzより低い場合は元のサンプリングレートが高くてもリサンプリングを行わない）（スペクトログラムは元のサンプルレートで生成）
7. **Given** 超音波録音にtime expansion値が設定されている状態で、**When** ユーザーが再生する、**Then** 指定の倍率で減速再生され可聴域の音として聴取できる
8. **Given** 音声が再生中の状態で、**When** 再生位置がスペクトログラム表示範囲の端に近づく、**Then** スペクトログラムのviewportが自動的に追従してスクロールする
9. **Given** 録音詳細ページで、**When** ユーザーがスペースキーを押す、**Then** 再生/一時停止がトグルされる
10. **Given** 録音詳細ページで、**When** ユーザーがスペクトログラムの表示幅と高さを変える、**Then** スペクトログラムを任意に拡大縮小できる
11. **Given** 録音詳細ページで、**When** ユーザーがスペクトログラム上をクリックする、**Then** その場所から再生される
12. **Given** 録音詳細ページで、**When** ユーザーが録音を削除する、**Then** 確認ダイアログの後、録音と関連するクリップがカスケード削除される
13. **Given** 録音一覧ページで、**When** ユーザーがプロジェクト全体を対象に検索する（時間範囲、位置範囲、タグ）、**Then** 複数のデータセットにまたがる録音が検索結果として表示される
14. **Given** 超音波録音（time_expansion != 1.0）の詳細ページで、**When** ユーザーがtime_expansion値を変更する、**Then** 新しいtime_expansion値が保存され、再生速度計算に反映される
15. **Given** クライアントが録音の音声データをリクエストする際に、**When** HTTP Range ヘッダーが含まれる、**Then** システムは206 Partial Contentで部分コンテンツを返し、効率的なストリーミング再生を実現する

---

### ユーザーストーリー 4 - クリップの作成と管理 (優先度: P2)

研究者は、アノテーションや分析のために特定の音声を分離するため、録音からクリップ（時間セグメント）を作成したい。
また、ML実行時にはクリップ単位で音源を管理する必要があるため、録音からクリップを作成したい。

**優先度の理由**: クリップはアノテーションとML予測の分析単位。アノテーションワークフローを開始する前に必要。

**独立テスト**: 録音からクリップを作成し、それらを独立して一覧表示、再生、管理できることを確認することでテスト可能。

**受け入れシナリオ**:

1. **Given** 録音がスペクトログラムとともに表示されている状態で、**When** ユーザーが時間範囲を選択する、**Then** その選択からクリップを作成できる
2. **Given** 録音が存在する状態で、**When** ユーザーが指定した長さとオーバーラップで自動クリップ生成を要求する、**Then** システムは録音全体をカバーするクリップを作成する
3. **Given** 録音にクリップが存在する状態で、**When** ユーザーが録音を閲覧する、**Then** 開始/終了時間を含む関連クリップの一覧が表示される
4. **Given** クリップが存在する状態で、**When** ユーザーがクリップ詳細を閲覧する、**Then** スペクトログラム可視化が表示され、音声セグメントを再生できる
5. **Given** クリップ詳細ページで、**When** ユーザーがクリップを削除する、**Then** 確認ダイアログの後、クリップと関連するアノテーション・ML予測がカスケード削除される

---

### ユーザーストーリー 5 - カスタムメタデータの管理 (優先度: P2)

研究者は、録音やクリップにカスタムメタデータ（ノート）を追加して、データの整理と検索を効率化したい。

**優先度の理由**: メタデータはデータの整理と検索に重要。基本機能が動作した後に追加できる拡張機能。

**独立テスト**: 録音やクリップにノートを追加し、それらで検索・フィルタリングできることを確認することでテスト可能。

**受け入れシナリオ**:

1. **Given** 録音が存在する状態で、**When** ユーザーがノートを追加する、**Then** ノートが保存され、録音詳細ページに表示される
4. **Given** クリップが存在する状態で、**When** ユーザーがノートを追加する、**Then** クリップにもメタデータが関連付けられる

---

### ユーザーストーリー 6 - 音声処理の設定 (優先度: P3)

研究者は、特定の音声データに最適化するためにスペクトログラム生成パラメータと音声フィルタリングをカスタマイズしたい（例：鳥の鳴き声とクジラの歌声では異なる周波数範囲が必要、ノイズの多い録音ではPCENデノイジングが有効）。

**優先度の理由**: 使いやすさに重要だが、システムは適切なデフォルトで動作すべき。パワーユーザー向けの拡張機能。

**独立テスト**: 音声パラメータを変更し、スペクトログラム出力と再生音声がそれに応じて変化することを確認することでテスト可能。

**受け入れシナリオ**:

1. **Given** ユーザーがスペクトログラムを閲覧している状態で、**When** FFTウィンドウサイズを調整する、**Then** スペクトログラムの解像度がそれに応じて変化する
2. **Given** ユーザーが音声パラメータを設定している状態で、**When** 最小/最大周波数範囲を設定する、**Then** スペクトログラムはその周波数帯域のみを表示する
3. **Given** データセットにカスタム音声パラメータがある状態で、**When** ユーザーがそのデータセットの録音を閲覧する、**Then** スペクトログラムはデフォルトでそれらのパラメータを使用する
4. **Given** ユーザーがスペクトログラムを閲覧している状態で、**When** カラーマップを選択する（gray, viridis, magma, inferno, plasma, cividis, cool, cubehelix, twilight）、**Then** スペクトログラムの色表現が変更される
5. **Given** ノイズの多い録音が存在する状態で、**When** ユーザーがPCEN（Per-Channel Energy Normalization）を有効にする、**Then** バックグラウンドノイズが抑制され信号成分が強調されたスペクトログラムが表示される
6. **Given** ユーザーが音声パラメータを設定している状態で、**When** ハイパスフィルタ（低周波カットオフ）またはローパスフィルタ（高周波カットオフ）を設定する、**Then** スペクトログラムと再生音声の両方にフィルタが適用される
7. **Given** マルチチャンネル録音が存在する状態で、**When** ユーザーがチャンネルを選択する、**Then** 選択したチャンネルのみがスペクトログラムと再生に使用される

---

### ユーザーストーリー 7 - データセットの可視性と共有 (優先度: P3)

研究者は、データセットへのアクセスを制御したい - 一部をプライベートに保ち、他を共同研究者や一般に共有する。

**優先度の理由**: コラボレーションに重要だが、最初はプライベートのみのデータセットで開始可能。

**独立テスト**: 異なる可視性設定でデータセットを作成し、アクセス制御が機能することを確認することでテスト可能。

**受け入れシナリオ**:

1. **Given** ユーザーがデータセットを作成する際に、**When** 可視性を「プライベート」に設定する、**Then** オーナーのみがアクセスできる
2. **Given** ユーザーがデータセットを作成する際に、**When** 可視性を「公開」に設定する、**Then** 認証済みユーザーは閲覧できる（ただし変更は不可）
3. **Given** データセットが存在する状態で、**When** オーナーが可視性設定を変更する、**Then** アクセス権限が即座に更新される

---

### ユーザーストーリー 8 - データセットと録音のエクスポート (優先度: P2)

研究者は、データセットや録音を標準形式でエクスポートして、他のツールでの分析や共同研究者との共有、論文投稿用のデータアーカイブを作成したい。

**優先度の理由**: データの再利用と共有に重要。基本的なデータ管理機能が動作した後に追加できる機能。

**独立テスト**: データセットをエクスポートし、出力されたファイルが正しい形式で全てのメタデータを含むことを確認することでテスト可能。

**受け入れシナリオ**:

1. **Given** データセットが存在する状態で、**When** ユーザーがCamtrapDP形式でエクスポートを要求する、**Then** deployments.csvとmedia.csvを含むZIPファイルがダウンロードされる
2. **Given** エクスポートダイアログで、**When** ユーザーが「音声ファイルを含める」オプションを選択する、**Then** ZIPファイルにAudio/ディレクトリが含まれ、全録音ファイルが元のディレクトリ構造で格納される
3. **Given** deployments.csvが生成される際に、**Then** 以下の情報が含まれる：サイト情報（位置、H3インデックス、coordinateUncertainty）、機器情報（レコーダーID、モデル）、日時範囲（deploymentStart/End）
4. **Given** media.csvが生成される際に、**Then** 各録音について以下の情報が含まれる：ファイルパス、サンプリングレート、ビット深度、チャンネル数、ゲイン、長さ、日時
5. **Given** 録音詳細ページで、**When** ユーザーが録音をダウンロードする、**Then** WAV形式で音声ファイルがダウンロードされる
6. **Given** 録音ダウンロード時に、**When** ユーザーが時間範囲を指定する（クリップ単位）、**Then** 指定された範囲のみがダウンロードされる
7. **Given** 大容量のデータセットをエクスポートする際に、**When** エクスポートが開始される、**Then** ストリーミングレスポンスで効率的にダウンロードが行われる（メモリ不足を防止）

#### CamtrapDP形式について

CamtrapDP（Camera Trap Data Package）は、生物多様性観測データの国際標準フォーマットです。元々はカメラトラップ用に設計されましたが、生物音響データにも拡張されています。

**参照**: https://camtrap-dp.tdwg.org/ / https://github.com/tdwg/camtrap-dp

##### deployments.csv カラム仕様

| カラム | 説明 | Echoroo実装 |
|--------|------|-------------|
| deploymentID | デプロイメント識別子 | データセットUUID |
| locationID | 位置識別子 | site.site_id |
| locationName | 位置名 | site.site_name |
| latitude | 緯度 | H3インデックスから計算 |
| longitude | 経度 | H3インデックスから計算 |
| coordinateUncertainty | 座標不確実性（m） | H3セルの外接円半径から計算 |
| deploymentStart | デプロイメント開始日時 | データセット内の最初の録音日時 |
| deploymentEnd | デプロイメント終了日時 | データセット内の最後の録音日時 |
| deviceID | デバイス識別子 | recorder.recorder_id |
| deviceModel | デバイスモデル | recorder.recorder_name |
| deploymentComments | コメント | dataset.description |
| h3Index | H3セル識別子 | site.h3_index（Echoroo拡張フィールド） |

**coordinateUncertaintyの計算方法**:
H3六角形セルの中心から頂点までの距離（外接円半径）を計算し、位置の不確実性として使用します。これにより、H3解像度に応じた適切な不確実性が自動的に設定されます。

##### media.csv カラム仕様

| カラム | 説明 | Echoroo実装 |
|--------|------|-------------|
| mediaID | メディア識別子 | 録音UUIDの最初の20文字 |
| deploymentID | デプロイメント識別子 | データセットUUID |
| timestamp | 録音日時 | recording.datetime（ISO8601 UTC形式） |
| duration | 長さ（秒） | recording.duration |
| filePath | ファイルパス | recording.path |
| fileName | ファイル名 | パスのベース名 |
| fileMediatype | MIMEタイプ | audio/wav, audio/flac, audio/mpeg等 |
| bitDepth | ビット深度 | recording.bit_depth |
| samplingFrequency | サンプリングレート（Hz） | recording.samplerate |
| channels | チャンネル数 | recording.channels |
| gain | ゲイン（dB） | dataset.gain |

##### エクスポートZIPの構造

```
export.zip
├── deployments.csv    # デプロイメント情報（圧縮）
├── media.csv          # 録音メタデータ（圧縮）
└── Audio/             # 音声ファイル（オプション、非圧縮）
    └── [元のディレクトリ構造を保持]
```

---

### エッジケース

- サポートされていない音声フォーマットがアップロードされた場合どうなるか？ → システムはファイルをスキップし、インポートサマリーで報告する
- 録音ファイルが破損しているまたは読み取り不可の場合どうなるか？ → システムは録音を失敗としてマークし、他の処理を続行する
- 日時パターンの抽出に失敗した場合どうなるか？ → システムは日時メタデータなしで録音をインポートし、手動レビュー用にフラグを立てる
- インポート中にディスク容量が不足した場合どうなるか？ → システムはインポートを適切に停止し、ユーザーに通知する
- クリップやアノテーションを持つ録音をユーザーが削除した場合どうなるか？ → システムは警告を表示して確認を求め、関連エンティティをカスケード削除する
- 2人のユーザーが同じファイルをアップロードした場合どうなるか？ → システムは重複ファイルを検出し、スキップするか別エントリを作成するか選択肢を提供する

## 要件 *(必須)*

### 機能要件

#### データセット管理
- **FR-001**: システムは、名前、説明、可視性設定、**所属サイト（必須）**を持つデータセットの作成を許可しなければならない
- **FR-002**: システムは、指定されたディレクトリパスからの音声ファイルのインポートをサポートしなければならない
- **FR-003**: システムは、データセットステータス（待機中、スキャン中、処理中、完了、失敗）を追跡しなければならない
- **FR-004**: システムは、インポート時のファイル名からの日時パターン抽出をサポートしなければならない
- **FR-005**: システムは、インポート進捗のフィードバックとエラー報告を提供しなければならない
- **FR-005a**: システムは、データセットにレコーダー（録音機器）を関連付けることを許可しなければならない
- **FR-005b**: システムは、データセットにライセンスを関連付けることを許可しなければならない
- **FR-005c**: システムは、データセットにDOI（デジタルオブジェクト識別子）を設定することを許可しなければならない
- **FR-005d**: システムは、データセットにゲイン（dB）を設定することを許可しなければならない
- **FR-005e**: システムは、データセットにノート（内部用メモ）を設定することを許可しなければならない
- **FR-005f**: システムは、サーバー上のディレクトリを一覧し、インポート候補を検出する機能を提供しなければならない
- **FR-005g**: システムは、既存のデータセットの再スキャン（追加・変更・削除されたファイルの検出と反映）をサポートしなければならない
- **FR-005h**: システムは、データセットの詳細な統計情報（録音数、総再生時間、日付範囲、ファイル形式分布、サンプルレート分布）を提供しなければならない
- **FR-005i**: システムは、データセットの削除をサポートし、関連する録音とクリップをカスケード削除しなければならない

#### 録音管理
- **FR-006**: システムは、ファイル名、パス、長さ、サンプルレート、チャンネル数を含む録音メタデータを保存しなければならない
- **FR-007**: システムは、以下の音声フォーマットをサポートしなければならない：WAV、FLAC、MP3、OGG
- **FR-008**: システムは、オンデマンドで音声可視化用のスペクトログラムを生成しなければならない
- **FR-009**: システムは、時間範囲選択付きの音声再生をサポートしなければならない
- **FR-010**: システムは、録音がデータセット経由でサイトに関連付けられることを保証しなければならない
- **FR-011**: システムは、録音へのノートの追加をサポートしなければならない
- **FR-012**: システムは、超音波録音（サンプルレート > 48kHz）の再生時に自動的に48kHzにリサンプリングしなければならない（スペクトログラムは元のサンプルレートで生成）
- **FR-013**: システムは、再生速度の選択（0.1x〜3x、出力サンプルレート8kHz〜96kHz範囲内）をサポートしなければならない
- **FR-014**: システムは、超音波録音のtime expansion（減速再生による可聴化）をサポートしなければならない
- **FR-015**: システムは、再生位置に応じたスペクトログラムviewportの自動追従をサポートしなければならない
- **FR-016**: システムは、キーボードショートカット（スペースキーで再生/一時停止）をサポートしなければならない
- **FR-016a**: システムは、録音の削除をサポートし、関連するクリップをカスケード削除しなければならない
- **FR-016b**: システムは、プロジェクト全体を対象とした録音の横断検索（時間範囲、位置範囲、タグによるフィルタリング）をサポートしなければならない
- **FR-016c**: システムは、録音のtime_expansion値の編集をサポートしなければならない
- **FR-016d**: システムは、音声ストリーミング用にHTTP Rangeリクエストをサポートし、206 Partial Contentレスポンスを返さなければならない

#### クリップ管理
- **FR-017**: システムは、開始時間と終了時間を持つ録音からの手動クリップ作成を許可しなければならない
- **FR-018**: システムは、設定可能な長さとオーバーラップによる自動クリップ生成をサポートしなければならない
- **FR-019**: システムは、クリップのスペクトログラムを生成しなければならない
- **FR-020**: システムは、クリップ再生をサポートしなければならない
- **FR-020a**: システムは、クリップの削除をサポートしなければならない（将来実装されるアノテーション・ML予測のカスケード削除に対応した設計とする）

#### サイト管理
- **FR-021**: システムは、名前とUber H3インデックスを持つサイトの作成を許可しなければならない
- **FR-022**: システムは、H3解像度5〜15の範囲でのサイト定義をサポートしなければならない
- **FR-023**: システムは、マップ上でH3 hexを選択するUIを提供しなければならない
- **FR-024**: システムは、サイト位置のマップベース可視化（H3 hex表示）を提供しなければならない
- **FR-024a**: システムは、サイトの名前とH3インデックスの編集をサポートしなければならない
- **FR-024b**: システムは、サイトの削除をサポートし、関連するデータセット・録音・クリップをカスケード削除しなければならない
- **FR-024c**: システムは、データセットを持つサイトを削除する際に影響を受けるデータの数を警告し、確認を求めなければならない

#### 音声処理
- **FR-025**: システムは、設定可能なスペクトログラムパラメータ（FFTサイズ、ホップ長、周波数範囲）をサポートしなければならない
- **FR-026**: システムは、パフォーマンスのために生成されたスペクトログラムをキャッシュしなければならない
- **FR-027**: システムは、カラーマップの選択（gray, viridis, magma, inferno, plasma, cividis, cool, cubehelix, twilight）をサポートしなければならない
- **FR-028**: システムは、PCEN（Per-Channel Energy Normalization）によるデノイジングをサポートしなければならない
- **FR-029**: システムは、ハイパスフィルタとローパスフィルタをサポートし、スペクトログラムと再生音声の両方に適用しなければならない
- **FR-030**: システムは、マルチチャンネル録音のチャンネル選択をサポートしなければならない

#### アクセス制御
- **FR-031**: システムは、データセットの可視性設定（プライベート、公開）を強制しなければならない
- **FR-032**: システムは、データセットと録音の所有権を追跡しなければならない
- **FR-033**: システムは、データセットへの不正な変更を防止しなければならない

#### エクスポート
- **FR-034**: システムは、データセットをCamtrapDP形式（deployments.csv + media.csv）でエクスポートできなければならない
- **FR-035**: システムは、エクスポート時に音声ファイルを含めるオプションを提供しなければならない
- **FR-036**: システムは、個別の録音をWAV形式でダウンロードできなければならない
- **FR-037**: システムは、録音の時間範囲を指定したダウンロード（クリップ単位）をサポートしなければならない
- **FR-038**: システムは、大容量エクスポート時にストリーミングレスポンスを使用しなければならない
- **FR-039**: システムは、エクスポートされるdeployments.csvにサイト情報（H3インデックス、coordinateUncertainty）、機器情報、日時範囲を含めなければならない
- **FR-040**: システムは、エクスポートされるmedia.csvに録音メタデータ（パス、サンプリングレート、ビット深度、チャンネル数、ゲイン、長さ、日時）を含めなければならない

### 主要エンティティ

- **Site（サイト）**: フィールド調査を行う地理的位置。Uber H3インデックス（解像度5〜15）と名前を持ち、プロジェクトに必ず属する。複数のデータセットを持つことができる
- **Dataset（データセット）**: 特定の目的のためにグループ化された録音のコレクション。名前、説明、可視性ステータス、インポートステータスを持ち、**サイトに必ず属する**（サイトのないデータセットは作成不可）。以下のメタデータを関連付けることができる：
  - レコーダー（Recorder）- 使用した録音機器（001-administrationで管理されるマスタデータへの参照）
  - ライセンス（License）- データセットに適用されるライセンス（001-administrationで管理されるマスタデータへの参照）
  - DOI - デジタルオブジェクト識別子
  - ゲイン（dB）- 録音時の増幅設定
  - ノート - 内部用メモ
- **Recording（録音）**: メタデータを持つ単一の音声ファイル。ファイル名、ファイルパス、長さ、サンプルレート、チャンネル数、日時、time_expansion（超音波録音の減速再生倍率、デフォルト1.0）、ノート（テキスト注釈）を持ち、データセットに属する。複数のクリップを持つことができる
- **Clip（クリップ）**: 録音内の時間セグメント。開始時間、終了時間、ノート（テキスト注釈）、親録音への参照を持つ。将来のアノテーション機能とML予測機能の分析単位として設計されている

### 将来機能（本フェーズでは実装しない）

以下の機能は将来のフェーズで実装予定：

- **Annotation（アノテーション）**: クリップに対する種同定などのラベル付け機能
- **ML Prediction（ML予測）**: 機械学習モデルによる自動種同定結果
- **Tag（タグ）**: エンティティの分類とフィルタリングのためのキーと値のペア

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: ユーザーは1000件の録音を含むデータセットを10分以内にインポートできる（ネットワーク転送時間を除く）
- **SC-002**: 録音一覧は10,000件の録音を持つデータセットに対して2秒以内に読み込まれる
- **SC-003**: スペクトログラム生成は10分以内の録音に対して3秒以内に完了する
- **SC-004**: 95%のユーザーがサポートなしで最初のデータセットのインポートに成功できる
- **SC-005**: 音声再生はユーザーのリクエストから500ms以内に開始される
- **SC-006**: システムはパフォーマンス低下なしに50人の同時アクセスをサポートできる
- **SC-007**: ユーザーはフィルタを使用して30秒以内に特定の録音を見つけることができる
- **SC-008**: マップ可視化は1000件以上の録音の位置マーカーをスムーズに描画できる

## 前提条件

- ユーザーは音声ファイルへのローカルまたはネットワークアクセスを持っている
- 音声ファイルは標準フォーマット（WAV、FLAC、MP3、OGG）である
- ユーザーは基本的な音声用語（サンプルレート、長さ、スペクトログラム）を理解している
- 地理座標は標準の10進度形式で提供される
- デフォルトのスペクトログラムパラメータは一般的な生物音響アプリケーション（鳥や野生動物の音声）に適している
