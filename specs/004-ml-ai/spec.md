# 機能仕様書: 機械学習・AI機能

**フィーチャーブランチ**: `004-ml-ai`
**作成日**: 2026-01-15
**ステータス**: ドラフト
**入力**: 機械学習・AI機能（種検出、カスタムモデル、検索、評価）

## ユーザーシナリオとテスト *(必須)*

### ユーザーストーリー 1 - 基盤モデルによる種検出 (優先度: P1)

研究者は、録音データセットに対してBirdNETやPerchなどの事前学習済みモデルを実行し、含まれる種を自動検出したい。

**優先度の理由**: 手動アノテーションなしで大量データを処理できる最も基本的なML機能。これがなければML機能の価値がない。

**独立テスト**: データセットを選択し、モデルを実行して検出結果を確認することでテスト可能。

**受け入れシナリオ**:

1. **Given** データセットが存在する状態で、**When** 基盤モデル（BirdNET）を選択して実行する、**Then** バックグラウンドで推論ジョブが開始される
2. **Given** 推論ジョブが実行中の状態で、**When** 進捗を確認する、**Then** 処理済みクリップ数と推定残り時間が表示される
3. **Given** 推論が完了した状態で、**When** 結果を閲覧する、**Then** 検出された種とその信頼度スコアが一覧表示される
4. **Given** 検出結果が存在する状態で、**When** 特定の種でフィルタリングする、**Then** その種が検出されたクリップのみが表示される

---

### ユーザーストーリー 2 - 種フィルタの適用 (優先度: P1)

研究者は、地理的・時間的フィルタを適用して、その地域・季節に存在しうる種のみに検出結果を絞り込みたい。

**優先度の理由**: 誤検出を削減し、結果の精度を大幅に向上させる重要な機能。

**独立テスト**: フィルタを作成・適用し、結果が絞り込まれることを確認。

**受け入れシナリオ**:

1. **Given** 録音に地理情報がある状態で、**When** 地理的種フィルタを作成する、**Then** その地域で観察記録のある種のリストが生成される
2. **Given** 種フィルタが存在する状態で、**When** モデル実行結果に適用する、**Then** フィルタ外の種が除外されて表示される
3. **Given** フィルタ適用後の結果で、**When** 除外された検出を確認する、**Then** なぜ除外されたか（地域外、季節外など）が表示される

---

### ユーザーストーリー 3 - リファレンスサウンドによる検索 (優先度: P2)

研究者は、特定の音声（リファレンスサウンド）に類似した音声をデータセット全体から検索したい。

**優先度の理由**: 既知の音声パターンを基に未知のデータを探索できる強力な検索機能。

**独立テスト**: リファレンスサウンドを登録し、類似検索を実行して結果を確認。

**受け入れシナリオ**:

1. **Given** クリップが存在する状態で、**When** リファレンスサウンドとして登録する、**Then** 埋め込みベクトルが生成されて保存される
2. **Given** Xeno-canto（外部データベース）で、**When** 種名で検索してリファレンスを追加する、**Then** 外部音声がリファレンスとして登録される
3. **Given** リファレンスサウンドが存在する状態で、**When** 類似検索を実行する、**Then** 類似度スコア順にクリップが表示される
4. **Given** 検索結果が表示されている状態で、**When** 類似度閾値を調整する、**Then** 表示されるクリップ数が変化する

---

### ユーザーストーリー 4 - アクティブラーニング検索セッション (優先度: P2)

研究者は、反復的なフィードバックを通じて検索精度を向上させ、目的の音声を効率的に発見したい。

**優先度の理由**: 少量のラベル付きデータから効率的に目的データを発見できる高度な検索手法。

**独立テスト**: 検索セッションを開始し、数回のフィードバックを行って精度向上を確認。

**受け入れシナリオ**:

1. **Given** リファレンスサウンドがある状態で、**When** 検索セッションを開始する、**Then** 初期検索結果が表示される
2. **Given** 検索結果が表示されている状態で、**When** 各結果に対してポジティブ/ネガティブ/不明のラベルを付ける、**Then** フィードバックが保存される
3. **Given** フィードバックを提供した状態で、**When** 次のイテレーションを実行する、**Then** フィードバックを反映した新しい検索結果が表示される
4. **Given** 複数イテレーション後に、**When** セッション結果をエクスポートする、**Then** ラベル付きクリップ一覧がダウンロードされる

---

### ユーザーストーリー 5 - カスタムモデルの学習 (優先度: P2)

研究者は、自分のアノテーションデータや検索セッション結果を使って、特定の種に特化したカスタム分類モデルを学習したい。

**優先度の理由**: 基盤モデルでカバーされない種や、より高精度な検出が必要な場合に対応。

**独立テスト**: 学習データを選択し、モデルを学習させて推論に使用できることを確認。

**受け入れシナリオ**:

1. **Given** ラベル付きデータ（アノテーションまたは検索結果）がある状態で、**When** カスタムモデル学習を開始する、**Then** バックグラウンドで学習ジョブが開始される
2. **Given** 学習が完了した状態で、**When** モデル詳細を確認する、**Then** 学習データ数、パラメータ、評価メトリクスが表示される
3. **Given** 学習済みモデルが存在する状態で、**When** 新しいデータセットに対して推論を実行する、**Then** カスタムモデルによる予測結果が生成される
4. **Given** 複数のモデルが存在する状態で、**When** モデルを比較する、**Then** 精度指標を並べて確認できる

---

### ユーザーストーリー 6 - モデル評価 (優先度: P3)

研究者は、モデルの精度を評価セットを使って定量的に測定し、異なるモデルや設定を比較したい。

**優先度の理由**: モデル品質の客観的評価に重要だが、基本的な検出機能が先。

**独立テスト**: 評価セットを作成し、モデルを評価してメトリクスを確認。

**受け入れシナリオ**:

1. **Given** アノテーション済みデータがある状態で、**When** 評価セットを作成する、**Then** 正解ラベル付きのテストデータセットが生成される
2. **Given** 評価セットとモデル実行結果がある状態で、**When** 評価を実行する、**Then** Precision、Recall、F1スコアが計算される
3. **Given** 評価結果が存在する状態で、**When** 混同行列を表示する、**Then** 予測と正解のクロス集計が可視化される
4. **Given** 複数の評価結果がある状態で、**When** 比較レポートを生成する、**Then** モデル間の性能差が表示される

---

### ユーザーストーリー 7 - 検出結果の可視化 (優先度: P3)

研究者は、検出結果を時間的・地理的に可視化して、種の分布パターンを理解したい。

**優先度の理由**: データ解釈に有用だが、基本的な検出・検索機能が優先。

**独立テスト**: 検出結果を選択し、各種可視化が正しく表示されることを確認。

**受け入れシナリオ**:

1. **Given** 検出結果がある状態で、**When** 時間ヒートマップを表示する、**Then** 時間帯別の検出頻度が可視化される
2. **Given** 地理情報付き検出結果で、**When** マップビューを表示する、**Then** 検出位置が地図上にプロットされる
3. **Given** 複数種の検出結果で、**When** 種別フィルタを適用する、**Then** 選択した種のみの分布が表示される

---

### エッジケース

- GPUメモリ不足で推論が失敗した場合どうなるか？ → バッチサイズを自動調整してリトライ、または警告を表示
- 基盤モデルが対応していない種を検出しようとした場合どうなるか？ → 事前に対応種リストを表示し、カスタムモデルの使用を提案
- 検索セッションで全てネガティブとラベル付けした場合どうなるか？ → 警告を表示し、リファレンスの見直しを提案
- 学習データが不足している状態でモデル学習を開始した場合どうなるか？ → 最低必要データ数を表示してブロック
- 推論ジョブが途中で中断された場合どうなるか？ → 中断位置から再開可能

## 要件 *(必須)*

### 機能要件

#### 基盤モデル管理
- **FR-001**: システムは、利用可能な基盤モデル（BirdNET、Perch等）の一覧を表示できなければならない
- **FR-002**: システムは、各モデルのバージョンと対応種リストを管理できなければならない
- **FR-003**: システムは、モデルの稼働状態（利用可能/メンテナンス中）を表示できなければならない

#### 推論ジョブ管理
- **FR-004**: システムは、データセット単位で推論ジョブを作成・実行できなければならない
- **FR-005**: システムは、推論ジョブのステータス（待機中/実行中/完了/失敗）を追跡できなければならない
- **FR-006**: システムは、推論の進捗状況をリアルタイムで表示できなければならない
- **FR-007**: システムは、推論ジョブをキャンセルできなければならない
- **FR-008**: システムは、重い処理をバックグラウンドで非同期実行しなければならない

#### 種フィルタ
- **FR-009**: システムは、地理的な種出現データに基づくフィルタを作成できなければならない
- **FR-010**: システムは、外部データベース（GBIF）から種出現情報を取得できなければならない
- **FR-011**: システムは、フィルタを検出結果に適用して表示を絞り込めなければならない

#### 埋め込みと類似検索
- **FR-012**: システムは、クリップの埋め込みベクトルを生成・保存できなければならない
- **FR-013**: システムは、ベクトル類似度に基づく検索を実行できなければならない
- **FR-014**: システムは、類似度閾値によるフィルタリングをサポートしなければならない

#### リファレンスサウンド
- **FR-015**: システムは、既存クリップからリファレンスサウンドを作成できなければならない
- **FR-016**: システムは、外部ソース（Xeno-canto）からリファレンスをインポートできなければならない
- **FR-017**: システムは、カスタム音声ファイルをリファレンスとしてアップロードできなければならない
- **FR-018**: システムは、リファレンスサウンドのスペクトログラムと再生をサポートしなければならない

#### アクティブラーニング
- **FR-019**: システムは、検索セッションを作成・管理できなければならない
- **FR-020**: システムは、検索結果へのユーザーフィードバック（ポジティブ/ネガティブ/不明）を記録できなければならない
- **FR-021**: システムは、フィードバックを反映した反復的な検索を実行できなければならない
- **FR-022**: システムは、検索セッションの結果をエクスポートできなければならない

#### カスタムモデル
- **FR-023**: システムは、ラベル付きデータからカスタム分類モデルを学習できなければならない
- **FR-024**: システムは、モデル学習のステータスと進捗を追跡できなければならない
- **FR-025**: システムは、学習済みカスタムモデルで推論を実行できなければならない
- **FR-026**: システムは、モデルのメタデータ（パラメータ、学習データ数）を保存できなければならない

#### モデル評価
- **FR-027**: システムは、正解ラベル付きの評価セットを作成できなければならない
- **FR-028**: システムは、予測結果と正解を比較して評価メトリクスを計算できなければならない
- **FR-029**: システムは、Precision、Recall、F1スコアを表示できなければならない
- **FR-030**: システムは、評価結果をエクスポートできなければならない

#### 可視化
- **FR-031**: システムは、検出結果の時間的分布をヒートマップで表示できなければならない
- **FR-032**: システムは、検出結果の地理的分布をマップで表示できなければならない

### 主要エンティティ

- **FoundationModel（基盤モデル）**: 事前学習済みの音声分類モデル。名前、バージョン、対応種リスト、設定を持つ
- **ModelRun（モデル実行）**: 推論ジョブの実行記録。対象データセット、使用モデル、ステータス、開始/終了時刻を持つ
- **Prediction（予測）**: 個々のクリップに対する予測結果。クリップ、タグ、信頼度スコアを持つ
- **SpeciesFilter（種フィルタ）**: 種出現を制限するフィルタ。種類（地理的/時間的/カスタム）、適用条件を持つ
- **ReferenceSound（リファレンスサウンド）**: 検索の基準となる音声。ソース（クリップ/外部/アップロード）、埋め込みベクトル、メタデータを持つ
- **SearchSession（検索セッション）**: アクティブラーニング検索の単位。対象タグ、リファレンス、イテレーション数を持つ
- **SearchResult（検索結果）**: 検索で見つかったクリップ。類似度スコア、ユーザーラベルを持つ
- **CustomModel（カスタムモデル）**: ユーザーが学習したモデル。学習データソース、パラメータ、ステータスを持つ
- **EvaluationSet（評価セット）**: モデル評価用のデータセット。正解ラベル付きクリップの集合
- **Evaluation（評価）**: モデル評価の結果。評価セット、対象モデル実行、メトリクスを持つ

## 成功基準 *(必須)*

### 測定可能な成果

- **SC-001**: 1時間分の録音に対する推論が5分以内に完了する
- **SC-002**: 1000クリップの類似検索が3秒以内に結果を返す
- **SC-003**: アクティブラーニングにより、5回のイテレーションで目的クリップの発見率が80%以上に達する
- **SC-004**: カスタムモデルの学習が10,000サンプルに対して30分以内に完了する
- **SC-005**: 基盤モデルの種検出精度がベースライン（BirdNET公称値）と同等以上
- **SC-006**: 同時に10件の推論ジョブを処理できる
- **SC-007**: 推論ジョブの進捗が5秒以内に更新される
- **SC-008**: 種フィルタ適用により誤検出が50%以上削減される

## 前提条件

- 推論処理にはGPUリソースが利用可能（CPUフォールバックもサポート）
- 基盤モデル（BirdNET、Perch）は別途インストール・設定済み
- 類似検索にはベクトルデータベース機能が必要
- Xeno-canto APIへのアクセスにはインターネット接続が必要
- 大規模なモデル学習にはバックグラウンドワーカーが必要
